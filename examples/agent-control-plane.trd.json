{
  "metadata": {
    "id": "trd-agent-control-plane-001",
    "title": "Agent and MCP Control Plane Technical Requirements",
    "version": "1.0.0",
    "status": "draft",
    "createdAt": "2025-12-19T00:00:00Z",
    "updatedAt": "2025-12-19T00:00:00Z",
    "authors": [
      {
        "name": "John Wang",
        "role": "Author"
      }
    ],
    "tags": [
      "architecture",
      "spiffe",
      "security",
      "kubernetes",
      "microservices"
    ],
    "relatedDocuments": [
      {
        "title": "Agent and MCP Control Plane PRD",
        "url": "agent-control-plane.prd.json",
        "relationship": "implements",
        "description": "Product requirements this TRD implements"
      },
      {
        "title": "AI Agent Governance Platform MRD",
        "url": "agent-platform.mrd.json",
        "relationship": "references",
        "description": "Market requirements driving this technical design"
      }
    ]
  },
  "executiveSummary": {
    "purpose": "Define the technical architecture and implementation requirements for the Agent and MCP Control Plane - a governance infrastructure for AI agent ecosystems providing cryptographic identity, trust attestation, credential injection, and audit logging.",
    "scope": "This document covers the control plane architecture, component design, API specifications, security design, and deployment requirements. It does not cover agent framework internals or LLM model implementation.",
    "technicalApproach": "Microservices architecture deployed on Kubernetes, following the control plane / data plane separation pattern used by Istio and Envoy. SPIFFE/SPIRE provides workload identity, with a custom Governance Proxy for credential injection and policy enforcement.",
    "keyDecisions": [
      "SPIFFE/SPIRE for agent identity (CNCF standard)",
      "Go for core services (performance, SPIFFE ecosystem)",
      "PostgreSQL with row-level security for multi-tenancy",
      "Redis for policy caching and rate limiting",
      "mTLS for all inter-service communication"
    ],
    "outOfScope": [
      "Agent runtime/framework implementation",
      "LLM model hosting or inference",
      "End-user chatbot UI",
      "Mobile applications"
    ]
  },
  "architecture": {
    "overview": "The architecture follows the industry-standard control plane / data plane separation. The Control Plane handles configuration, policy management, and identity issuance. The Data Plane (Governance Proxy) handles request processing, credential injection, and policy enforcement at runtime.",
    "principles": [
      "Defense in depth - multiple security layers",
      "Zero trust - verify every request, assume breach",
      "Credential isolation - agents never possess secrets",
      "Observability - comprehensive logging and tracing",
      "Horizontal scalability - stateless services where possible"
    ],
    "patterns": [
      "Microservices",
      "Control Plane / Data Plane",
      "Sidecar Proxy",
      "Event Sourcing (audit logs)",
      "CQRS (command/query separation)"
    ],
    "components": [
      {
        "id": "spire-server",
        "name": "SPIRE Server",
        "description": "SPIFFE Runtime Environment server for issuing and managing SVIDs (SPIFFE Verifiable Identity Documents)",
        "type": "Service",
        "responsibilities": [
          "Issue X.509 SVIDs to registered workloads",
          "Manage registration entries for agents and MCP servers",
          "Rotate SVIDs automatically before expiry",
          "Federate with external SPIFFE trust domains"
        ],
        "dependencies": [
          "postgres-db"
        ],
        "technology": "SPIRE (Go)",
        "owner": "Platform Team"
      },
      {
        "id": "governance-proxy",
        "name": "Governance Proxy",
        "description": "Core data plane component that intercepts all agent requests, validates identity, injects credentials, and logs actions",
        "type": "Service",
        "responsibilities": [
          "Validate SPIFFE identity via mTLS",
          "Validate KYA attestation status",
          "Validate user delegation for acting-as requests",
          "Inject OAuth tokens for SaaS APIs",
          "Inject LLM API keys",
          "Enforce model-level LLM policies",
          "Log all requests with full context",
          "Strip credentials from responses"
        ],
        "dependencies": [
          "spire-server",
          "secrets-vault",
          "policy-service",
          "audit-service"
        ],
        "technology": "Go, Envoy-based",
        "owner": "Platform Team"
      },
      {
        "id": "secrets-vault",
        "name": "Secrets Vault",
        "description": "HSM-backed storage for OAuth tokens, LLM API keys, and other credentials",
        "type": "Service",
        "responsibilities": [
          "Store OAuth access and refresh tokens",
          "Store LLM provider API keys",
          "Store tool/service API keys",
          "Encrypt all secrets with HSM-backed keys",
          "Automatic token refresh before expiry",
          "Audit all secret access"
        ],
        "dependencies": [
          "postgres-db",
          "hsm-service"
        ],
        "technology": "Go",
        "owner": "Security Team"
      },
      {
        "id": "kya-service",
        "name": "KYA Attestation Service",
        "description": "Know Your Agent service for verifying and attesting agent trustworthiness",
        "type": "Service",
        "responsibilities": [
          "Process attestation submissions",
          "Verify agent capabilities",
          "Run automated security checks",
          "Issue signed attestations",
          "Manage attestation lifecycle (issue, renew, revoke)"
        ],
        "dependencies": [
          "postgres-db",
          "spire-server"
        ],
        "technology": "Go",
        "owner": "Security Team"
      },
      {
        "id": "policy-service",
        "name": "Policy Service",
        "description": "Central policy management and evaluation service",
        "type": "Service",
        "responsibilities": [
          "Store organization policies",
          "Evaluate access decisions",
          "Manage LLM model policies",
          "Manage delegation policies",
          "Cache policies in Redis"
        ],
        "dependencies": [
          "postgres-db",
          "redis-cache"
        ],
        "technology": "Go, OPA (Open Policy Agent)",
        "owner": "Platform Team"
      },
      {
        "id": "audit-service",
        "name": "Audit Service",
        "description": "Immutable audit logging service for all control plane actions",
        "type": "Service",
        "responsibilities": [
          "Receive and store audit events",
          "Ensure log immutability",
          "Support SIEM export",
          "Provide audit query API"
        ],
        "dependencies": [
          "postgres-db",
          "object-storage"
        ],
        "technology": "Go",
        "owner": "Security Team"
      },
      {
        "id": "portal-api",
        "name": "Portal API",
        "description": "Backend API for the web portal serving all personas",
        "type": "Service",
        "responsibilities": [
          "End-user delegation management",
          "Agent/MCP server registration",
          "KYA submission workflow",
          "Admin policy management",
          "Audit log viewing"
        ],
        "dependencies": [
          "policy-service",
          "kya-service",
          "secrets-vault",
          "audit-service"
        ],
        "technology": "Go",
        "owner": "Product Team"
      },
      {
        "id": "portal-web",
        "name": "Portal Web UI",
        "description": "Web frontend for the control plane portal",
        "type": "Frontend",
        "responsibilities": [
          "End-user experience",
          "Agent creator experience",
          "Admin dashboard",
          "Audit log viewer"
        ],
        "dependencies": [
          "portal-api"
        ],
        "technology": "React, TypeScript",
        "owner": "Product Team"
      },
      {
        "id": "postgres-db",
        "name": "PostgreSQL Database",
        "description": "Primary relational database with row-level security for multi-tenancy",
        "type": "Database",
        "responsibilities": [
          "Store organization data",
          "Store agent/MCP registrations",
          "Store delegations",
          "Store policies",
          "Enforce row-level security"
        ],
        "technology": "PostgreSQL 16",
        "owner": "Platform Team"
      },
      {
        "id": "redis-cache",
        "name": "Redis Cache",
        "description": "In-memory cache for policies and rate limiting",
        "type": "Cache",
        "responsibilities": [
          "Cache evaluated policies",
          "Rate limiting counters",
          "Session data"
        ],
        "technology": "Redis 7",
        "owner": "Platform Team"
      }
    ],
    "dataFlows": [
      {
        "id": "df-agent-request",
        "name": "Agent API Request",
        "source": "agent",
        "destination": "governance-proxy",
        "dataType": "API Request",
        "protocol": "mTLS (HTTPS)",
        "description": "Agent makes API request with SVID for identity"
      },
      {
        "id": "df-credential-injection",
        "name": "Credential Injection",
        "source": "governance-proxy",
        "destination": "secrets-vault",
        "dataType": "Credential Request",
        "protocol": "gRPC/mTLS",
        "description": "Proxy retrieves credentials for injection into upstream request"
      },
      {
        "id": "df-policy-check",
        "name": "Policy Evaluation",
        "source": "governance-proxy",
        "destination": "policy-service",
        "dataType": "Policy Query",
        "protocol": "gRPC/mTLS",
        "description": "Proxy checks if request is allowed by policy"
      },
      {
        "id": "df-audit-log",
        "name": "Audit Event",
        "source": "governance-proxy",
        "destination": "audit-service",
        "dataType": "Audit Event",
        "protocol": "gRPC/mTLS (async)",
        "description": "Proxy sends audit event for every request"
      },
      {
        "id": "df-svid-issuance",
        "name": "SVID Issuance",
        "source": "spire-agent",
        "destination": "spire-server",
        "dataType": "SVID Request",
        "protocol": "gRPC/mTLS",
        "description": "SPIRE agent requests SVID for workload"
      }
    ],
    "architectureDecisions": [
      {
        "id": "adr-001",
        "title": "Use SPIFFE/SPIRE for Workload Identity",
        "status": "Accepted",
        "context": "We need a standardized way to provide cryptographic identity to AI agents and MCP servers.",
        "decision": "Adopt SPIFFE/SPIRE as the workload identity system for all agents and MCP servers.",
        "consequences": [
          "Agents get cryptographic X.509 identities",
          "Automatic certificate rotation",
          "Federation capability with external systems",
          "Dependency on SPIFFE ecosystem"
        ],
        "alternatives": [
          "Custom PKI",
          "Cloud-specific identity (AWS IAM Roles)",
          "JWT-based identity"
        ],
        "date": "2025-01-15"
      },
      {
        "id": "adr-002",
        "title": "Credential Injection Pattern",
        "status": "Accepted",
        "context": "Agents need access to API credentials but storing credentials in agents creates security risks.",
        "decision": "Implement just-in-time credential injection where the Governance Proxy retrieves and injects credentials into upstream requests. Agents never possess credentials.",
        "consequences": [
          "Credentials never exposed to agents",
          "Centralized credential management",
          "Additional proxy latency (~5-10ms)",
          "Proxy becomes critical path"
        ],
        "alternatives": [
          "Agent-stored credentials",
          "Short-lived tokens to agents",
          "Sidecar vault agent"
        ],
        "date": "2025-01-15"
      },
      {
        "id": "adr-003",
        "title": "Control Plane / Data Plane Separation",
        "status": "Accepted",
        "context": "We need to separate configuration/management concerns from runtime request processing.",
        "decision": "Follow the Istio/Envoy pattern with separate Control Plane (configuration, policy, identity) and Data Plane (Governance Proxy for request processing).",
        "consequences": [
          "Clear separation of concerns",
          "Data plane can scale independently",
          "Follows industry-proven pattern",
          "More complex deployment"
        ],
        "alternatives": [
          "Monolithic architecture",
          "Full service mesh adoption"
        ],
        "date": "2025-01-15"
      },
      {
        "id": "adr-004",
        "title": "PostgreSQL with Row-Level Security for Multi-Tenancy",
        "status": "Accepted",
        "context": "We need to support multiple organizations with complete data isolation in a SaaS model.",
        "decision": "Use PostgreSQL row-level security (RLS) policies to enforce tenant isolation at the database level.",
        "consequences": [
          "Strong isolation guarantee at DB level",
          "Single database simplifies operations",
          "Some query performance overhead",
          "Requires careful policy design"
        ],
        "alternatives": [
          "Database per tenant",
          "Schema per tenant",
          "Application-level isolation only"
        ],
        "date": "2025-01-15"
      }
    ]
  },
  "technologyStack": {
    "languages": [
      {
        "name": "Go",
        "version": "1.22+",
        "purpose": "Backend services, Governance Proxy",
        "rationale": "Performance, SPIFFE ecosystem is Go-native, strong concurrency",
        "constraints": [
          "Must use Go modules"
        ]
      },
      {
        "name": "TypeScript",
        "version": "5.x",
        "purpose": "Portal Web UI",
        "rationale": "Type safety, React ecosystem, developer productivity"
      }
    ],
    "frameworks": [
      {
        "name": "gRPC",
        "purpose": "Inter-service communication",
        "rationale": "Performance, type safety, streaming support"
      },
      {
        "name": "React",
        "version": "18.x",
        "purpose": "Portal Web UI",
        "rationale": "Component model, large ecosystem, team expertise"
      },
      {
        "name": "Open Policy Agent (OPA)",
        "purpose": "Policy evaluation engine",
        "rationale": "Standard policy engine, Rego language, CNCF project"
      }
    ],
    "databases": [
      {
        "name": "PostgreSQL",
        "version": "16",
        "purpose": "Primary data store",
        "rationale": "Row-level security, JSONB support, proven reliability",
        "constraints": [
          "Must enable row-level security for all tenant tables"
        ]
      },
      {
        "name": "Redis",
        "version": "7",
        "purpose": "Caching and rate limiting",
        "rationale": "High performance, Redis Cluster for HA"
      }
    ],
    "infrastructure": [
      {
        "name": "Kubernetes",
        "version": "1.28+",
        "purpose": "Container orchestration",
        "rationale": "Industry standard, SPIRE integration"
      },
      {
        "name": "SPIRE",
        "version": "1.9+",
        "purpose": "Workload identity",
        "rationale": "CNCF graduated project, SPIFFE reference implementation"
      },
      {
        "name": "AWS KMS / Cloud HSM",
        "purpose": "Key management for secrets encryption",
        "rationale": "FIPS 140-2 compliance, managed service"
      }
    ],
    "monitoring": [
      {
        "name": "Prometheus",
        "purpose": "Metrics collection",
        "rationale": "Kubernetes-native, CNCF graduated"
      },
      {
        "name": "Grafana",
        "purpose": "Dashboards and visualization",
        "rationale": "Industry standard, Prometheus integration"
      },
      {
        "name": "OpenTelemetry",
        "purpose": "Distributed tracing",
        "rationale": "Vendor-neutral, CNCF project"
      },
      {
        "name": "Loki",
        "purpose": "Log aggregation",
        "rationale": "Grafana integration, cost-effective"
      }
    ],
    "cicd": [
      {
        "name": "GitHub Actions",
        "purpose": "CI/CD pipelines",
        "rationale": "GitHub integration, generous free tier"
      },
      {
        "name": "Helm",
        "purpose": "Kubernetes packaging",
        "rationale": "Standard Kubernetes deployment tool"
      },
      {
        "name": "ArgoCD",
        "purpose": "GitOps deployments",
        "rationale": "GitOps standard, Kubernetes-native"
      }
    ]
  },
  "apiSpecifications": [
    {
      "id": "api-governance-proxy",
      "name": "Governance Proxy API",
      "type": "REST",
      "version": "v1",
      "description": "Proxy API for credential injection and policy enforcement",
      "baseUrl": "https://proxy.agentgov.io",
      "auth": "mTLS (SVID)",
      "endpoints": [
        {
          "method": "ANY",
          "path": "/v1/llm/{provider}/*",
          "description": "Proxy LLM API requests (OpenAI, Anthropic, Google)",
          "request": "Original LLM API request",
          "response": "Original LLM API response"
        },
        {
          "method": "ANY",
          "path": "/v1/saas/{service}/*",
          "description": "Proxy SaaS API requests with OAuth injection",
          "request": "Original SaaS API request + X-Acting-As header",
          "response": "Original SaaS API response"
        },
        {
          "method": "ANY",
          "path": "/v1/tools/{tool}/*",
          "description": "Proxy tool API requests with API key injection",
          "request": "Original tool API request",
          "response": "Original tool API response"
        }
      ],
      "rateLimit": "Per-agent limits defined in policy"
    },
    {
      "id": "api-portal",
      "name": "Portal API",
      "type": "REST",
      "version": "v1",
      "description": "Management API for portal operations",
      "baseUrl": "https://api.agentgov.io",
      "auth": "OAuth 2.0 / API Key",
      "endpoints": [
        {
          "method": "POST",
          "path": "/v1/agents",
          "description": "Register a new agent",
          "request": "AgentRegistration",
          "response": "Agent"
        },
        {
          "method": "GET",
          "path": "/v1/agents/{agentId}",
          "description": "Get agent details",
          "response": "Agent"
        },
        {
          "method": "POST",
          "path": "/v1/agents/{agentId}/kya",
          "description": "Submit agent for KYA attestation",
          "request": "KYASubmission",
          "response": "KYAAttestation"
        },
        {
          "method": "POST",
          "path": "/v1/delegations",
          "description": "Create user delegation to agent",
          "request": "DelegationRequest",
          "response": "Delegation"
        },
        {
          "method": "DELETE",
          "path": "/v1/delegations/{delegationId}",
          "description": "Revoke delegation",
          "response": "204 No Content"
        },
        {
          "method": "GET",
          "path": "/v1/audit/events",
          "description": "Query audit events",
          "response": "AuditEventList"
        }
      ],
      "specUrl": "https://api.agentgov.io/openapi.yaml"
    },
    {
      "id": "api-internal-grpc",
      "name": "Internal gRPC APIs",
      "type": "gRPC",
      "version": "v1",
      "description": "Internal service-to-service APIs",
      "auth": "mTLS (SVID)",
      "endpoints": [
        {
          "method": "RPC",
          "path": "PolicyService.Evaluate",
          "description": "Evaluate access policy"
        },
        {
          "method": "RPC",
          "path": "SecretsService.GetCredential",
          "description": "Retrieve credential for injection"
        },
        {
          "method": "RPC",
          "path": "AuditService.LogEvent",
          "description": "Log audit event"
        },
        {
          "method": "RPC",
          "path": "KYAService.ValidateAttestation",
          "description": "Validate agent attestation status"
        }
      ]
    }
  ],
  "dataModel": {
    "overview": "The data model supports multi-tenant SaaS with complete tenant isolation via PostgreSQL row-level security. Core entities include Organizations, Agents, MCP Servers, Delegations, and Audit Events.",
    "entities": [
      {
        "id": "org",
        "name": "Organization",
        "description": "Tenant organization",
        "attributes": [
          {
            "name": "id",
            "type": "UUID",
            "required": true,
            "description": "Primary key"
          },
          {
            "name": "name",
            "type": "VARCHAR(255)",
            "required": true
          },
          {
            "name": "slug",
            "type": "VARCHAR(100)",
            "required": true,
            "constraints": "UNIQUE"
          },
          {
            "name": "plan",
            "type": "ENUM",
            "required": true,
            "description": "Pricing plan"
          },
          {
            "name": "created_at",
            "type": "TIMESTAMP",
            "required": true
          },
          {
            "name": "settings",
            "type": "JSONB",
            "description": "Organization settings"
          }
        ]
      },
      {
        "id": "agent",
        "name": "Agent",
        "description": "Registered AI agent",
        "attributes": [
          {
            "name": "id",
            "type": "UUID",
            "required": true
          },
          {
            "name": "org_id",
            "type": "UUID",
            "required": true,
            "description": "FK to Organization"
          },
          {
            "name": "spiffe_id",
            "type": "VARCHAR(512)",
            "required": true,
            "constraints": "UNIQUE"
          },
          {
            "name": "name",
            "type": "VARCHAR(255)",
            "required": true
          },
          {
            "name": "description",
            "type": "TEXT"
          },
          {
            "name": "status",
            "type": "ENUM",
            "required": true
          },
          {
            "name": "kya_attestation_id",
            "type": "UUID",
            "description": "FK to KYA Attestation"
          },
          {
            "name": "created_at",
            "type": "TIMESTAMP",
            "required": true
          },
          {
            "name": "metadata",
            "type": "JSONB"
          }
        ],
        "relationships": [
          "Organization (many-to-one)",
          "KYA Attestation (one-to-one)"
        ]
      },
      {
        "id": "delegation",
        "name": "Delegation",
        "description": "User authorization for agent to act on their behalf",
        "attributes": [
          {
            "name": "id",
            "type": "UUID",
            "required": true
          },
          {
            "name": "org_id",
            "type": "UUID",
            "required": true
          },
          {
            "name": "user_id",
            "type": "UUID",
            "required": true
          },
          {
            "name": "agent_id",
            "type": "UUID",
            "required": true
          },
          {
            "name": "service",
            "type": "VARCHAR(100)",
            "required": true,
            "description": "e.g., google, salesforce"
          },
          {
            "name": "scopes",
            "type": "TEXT[]",
            "required": true
          },
          {
            "name": "expires_at",
            "type": "TIMESTAMP"
          },
          {
            "name": "revoked_at",
            "type": "TIMESTAMP"
          },
          {
            "name": "created_at",
            "type": "TIMESTAMP",
            "required": true
          }
        ],
        "relationships": [
          "User (many-to-one)",
          "Agent (many-to-one)"
        ]
      },
      {
        "id": "kya-attestation",
        "name": "KYA Attestation",
        "description": "Know Your Agent attestation record",
        "attributes": [
          {
            "name": "id",
            "type": "UUID",
            "required": true
          },
          {
            "name": "agent_id",
            "type": "UUID",
            "required": true
          },
          {
            "name": "trust_level",
            "type": "ENUM",
            "required": true
          },
          {
            "name": "capabilities",
            "type": "TEXT[]"
          },
          {
            "name": "issued_at",
            "type": "TIMESTAMP",
            "required": true
          },
          {
            "name": "expires_at",
            "type": "TIMESTAMP",
            "required": true
          },
          {
            "name": "revoked_at",
            "type": "TIMESTAMP"
          },
          {
            "name": "signature",
            "type": "BYTEA",
            "required": true
          }
        ]
      },
      {
        "id": "audit-event",
        "name": "Audit Event",
        "description": "Immutable audit log entry",
        "attributes": [
          {
            "name": "id",
            "type": "UUID",
            "required": true
          },
          {
            "name": "org_id",
            "type": "UUID",
            "required": true
          },
          {
            "name": "timestamp",
            "type": "TIMESTAMP",
            "required": true
          },
          {
            "name": "event_type",
            "type": "VARCHAR(100)",
            "required": true
          },
          {
            "name": "agent_id",
            "type": "UUID"
          },
          {
            "name": "user_id",
            "type": "UUID"
          },
          {
            "name": "resource",
            "type": "VARCHAR(255)"
          },
          {
            "name": "action",
            "type": "VARCHAR(100)"
          },
          {
            "name": "outcome",
            "type": "ENUM",
            "required": true
          },
          {
            "name": "details",
            "type": "JSONB"
          }
        ]
      }
    ],
    "dataStores": [
      {
        "id": "ds-postgres",
        "name": "Primary PostgreSQL",
        "type": "PostgreSQL",
        "purpose": "Transactional data storage",
        "capacity": "100GB initial, auto-scale",
        "replication": "Multi-AZ synchronous replication",
        "backup": "Continuous WAL archiving, daily snapshots, 30-day retention"
      },
      {
        "id": "ds-redis",
        "name": "Redis Cluster",
        "type": "Redis",
        "purpose": "Caching and rate limiting",
        "capacity": "10GB",
        "replication": "Redis Cluster with 3 masters"
      },
      {
        "id": "ds-s3",
        "name": "Object Storage",
        "type": "S3-compatible",
        "purpose": "Audit log archival",
        "capacity": "Unlimited",
        "replication": "Cross-region replication",
        "backup": "Versioning enabled"
      }
    ],
    "migrations": "Flyway for schema migrations, with forward-only policy and automatic rollback on failure"
  },
  "securityDesign": {
    "overview": "Security is foundational to the Agent Governance Platform. The architecture implements defense in depth with multiple security layers: cryptographic identity (SPIFFE), mutual TLS for all communication, HSM-backed encryption, and comprehensive audit logging.",
    "authentication": {
      "method": "mTLS with SPIFFE SVIDs",
      "provider": "SPIRE",
      "mfa": true,
      "sessionManagement": "Stateless JWT for portal, SVID for agents",
      "details": "All agent authentication is via mTLS using X.509 SVIDs issued by SPIRE. Portal users authenticate via OIDC with MFA required."
    },
    "authorization": {
      "model": "RBAC with ABAC extensions",
      "policies": "OPA Rego policies",
      "roles": [
        "org_admin",
        "security_admin",
        "agent_creator",
        "end_user",
        "viewer"
      ],
      "details": "Fine-grained authorization using Open Policy Agent. Policies evaluate agent identity, user delegation, and organizational policies."
    },
    "encryption": {
      "atRest": "AES-256-GCM with HSM-backed keys",
      "inTransit": "TLS 1.3 minimum, mTLS for service-to-service",
      "keyManagement": "AWS KMS / Cloud HSM with automatic rotation",
      "details": "All sensitive data encrypted with per-tenant keys. Keys never leave HSM boundary."
    },
    "networkSecurity": {
      "firewall": "Kubernetes Network Policies",
      "waf": "AWS WAF / Cloudflare WAF",
      "ddosProtection": "Cloudflare DDoS protection",
      "networkPolicy": "Default deny, explicit allow",
      "segmentation": "Separate VPCs for control plane and data plane"
    },
    "compliance": [
      "SOC 2 Type II",
      "GDPR",
      "ISO 27001"
    ],
    "threatModel": [
      {
        "id": "tm-1",
        "name": "SVID Theft",
        "category": "Spoofing",
        "description": "Attacker steals SVID to impersonate agent",
        "likelihood": "Low",
        "impact": "High",
        "mitigation": "Short SVID TTL (1 hour), workload attestation, SVID revocation"
      },
      {
        "id": "tm-2",
        "name": "Credential Exposure",
        "category": "Information Disclosure",
        "description": "Credentials leaked via logs or memory",
        "likelihood": "Medium",
        "impact": "Critical",
        "mitigation": "Credentials never in agent memory, log scrubbing, memory encryption"
      },
      {
        "id": "tm-3",
        "name": "Privilege Escalation",
        "category": "Elevation of Privilege",
        "description": "Agent gains access beyond delegation scope",
        "likelihood": "Low",
        "impact": "High",
        "mitigation": "Scope enforcement at proxy, delegation validation, audit logging"
      },
      {
        "id": "tm-4",
        "name": "Proxy Bypass",
        "category": "Tampering",
        "description": "Agent bypasses proxy to access APIs directly",
        "likelihood": "Low",
        "impact": "High",
        "mitigation": "Network policies, agents have no credentials to bypass"
      }
    ],
    "securityControls": [
      {
        "id": "sc-1",
        "name": "mTLS Everywhere",
        "category": "Transport Security",
        "description": "All inter-service communication uses mTLS with SVID validation",
        "implementation": "SPIRE + Envoy sidecar"
      },
      {
        "id": "sc-2",
        "name": "Credential Isolation",
        "category": "Access Control",
        "description": "Agents never possess API credentials; credentials injected at proxy",
        "implementation": "Governance Proxy credential injection"
      },
      {
        "id": "sc-3",
        "name": "Immutable Audit Logs",
        "category": "Audit",
        "description": "All actions logged with cryptographic integrity",
        "implementation": "Append-only audit service with hash chaining"
      },
      {
        "id": "sc-4",
        "name": "Row-Level Security",
        "category": "Data Protection",
        "description": "Database enforces tenant isolation at row level",
        "implementation": "PostgreSQL RLS policies"
      }
    ]
  },
  "performance": {
    "overview": "The platform is designed for low-latency operation to minimize impact on agent request processing. The Governance Proxy is the critical path and must add minimal latency.",
    "requirements": [
      {
        "id": "perf-1",
        "name": "Proxy Latency",
        "metric": "Latency",
        "target": "< 50ms p99 (excluding upstream)",
        "priority": "Must",
        "measurement": "Prometheus histogram, distributed tracing"
      },
      {
        "id": "perf-2",
        "name": "SSE Streaming Overhead",
        "metric": "Latency",
        "target": "< 10ms added latency per chunk",
        "priority": "Must",
        "measurement": "Trace spans for chunk processing"
      },
      {
        "id": "perf-3",
        "name": "SVID Issuance",
        "metric": "Latency",
        "target": "< 500ms",
        "priority": "Should",
        "measurement": "SPIRE metrics"
      },
      {
        "id": "perf-4",
        "name": "Token Refresh",
        "metric": "Latency",
        "target": "< 1 second",
        "priority": "Must",
        "measurement": "Secrets vault metrics"
      },
      {
        "id": "perf-5",
        "name": "Policy Evaluation",
        "metric": "Latency",
        "target": "< 10ms",
        "priority": "Must",
        "measurement": "OPA decision logs"
      }
    ],
    "optimizations": [
      "Policy caching in Redis with 60-second TTL",
      "Connection pooling for database and upstream connections",
      "Async audit logging (fire-and-forget with retry)",
      "Credential pre-fetching for active delegations",
      "HTTP/2 multiplexing for proxy connections"
    ]
  },
  "scalability": {
    "overview": "The platform is designed for horizontal scalability with stateless services. The Governance Proxy and API services can scale independently based on load.",
    "horizontalScaling": "All services are stateless and horizontally scalable. Kubernetes HPA manages scaling based on CPU, memory, and custom metrics (requests per second).",
    "verticalScaling": "Database can scale vertically for write-heavy workloads. Consider read replicas for read scaling.",
    "loadBalancing": "Kubernetes Services with external load balancer. Session affinity not required (stateless).",
    "autoScaling": "HPA with target 70% CPU, 80% memory. Scale from 3 to 100 pods for Governance Proxy.",
    "limits": [
      {
        "name": "Concurrent Connections",
        "value": "10,000 per proxy instance",
        "rationale": "Envoy connection limits",
        "configurable": true
      },
      {
        "name": "Requests per Second",
        "value": "50,000 per proxy instance",
        "rationale": "Based on benchmarks",
        "configurable": true
      },
      {
        "name": "Registered Agents",
        "value": "100,000 per organization",
        "rationale": "Database index performance",
        "configurable": false
      },
      {
        "name": "Active Delegations",
        "value": "1,000,000 per organization",
        "rationale": "Database capacity",
        "configurable": false
      }
    ]
  },
  "deployment": {
    "overview": "The platform deploys on Kubernetes with Helm charts. Supports AWS, GCP, and Azure. Multi-region deployment for high availability.",
    "environments": [
      {
        "name": "Development",
        "purpose": "Developer testing and experimentation",
        "url": "https://dev.agentgov.io",
        "resources": "Minimal (single replica per service)",
        "accessLevel": "Engineering team"
      },
      {
        "name": "Staging",
        "purpose": "Pre-production testing and validation",
        "url": "https://staging.agentgov.io",
        "resources": "Production-like (reduced scale)",
        "accessLevel": "Engineering and QA"
      },
      {
        "name": "Production",
        "purpose": "Customer-facing production environment",
        "url": "https://agentgov.io",
        "resources": "Full scale with auto-scaling",
        "accessLevel": "Restricted (SRE and on-call)"
      }
    ],
    "strategy": "Blue-green deployment with automatic rollback on health check failure",
    "infrastructure": "Kubernetes (EKS/GKE/AKS)",
    "regions": [
      "us-east-1 (primary)",
      "us-west-2 (secondary)",
      "eu-west-1 (EU customers)"
    ],
    "highAvailability": "Multi-AZ deployment with automatic failover. 3 replicas minimum for critical services.",
    "disasterRecovery": "Cross-region replication for database. RPO: 1 minute, RTO: 5 minutes."
  },
  "integrations": [
    {
      "id": "int-oauth-providers",
      "name": "OAuth Providers",
      "type": "API",
      "direction": "Bidirectional",
      "protocol": "OAuth 2.0",
      "authMethod": "OAuth 2.0",
      "dataFormat": "JSON",
      "frequency": "On-demand",
      "description": "Connect user accounts from Google, Microsoft, Salesforce, GitHub",
      "documentation": "OAuth 2.0 spec + provider docs"
    },
    {
      "id": "int-llm-providers",
      "name": "LLM Providers",
      "type": "API",
      "direction": "Outbound",
      "protocol": "HTTPS",
      "authMethod": "API Key",
      "dataFormat": "JSON",
      "frequency": "Real-time",
      "description": "Proxy requests to OpenAI, Anthropic, Google AI, Azure OpenAI",
      "documentation": "Provider API documentation"
    },
    {
      "id": "int-siem",
      "name": "SIEM Integration",
      "type": "Webhook",
      "direction": "Outbound",
      "protocol": "HTTPS",
      "authMethod": "API Key",
      "dataFormat": "JSON (CEF optional)",
      "frequency": "Near real-time",
      "description": "Export audit logs to customer SIEM (Splunk, Datadog, etc.)"
    },
    {
      "id": "int-sso",
      "name": "SSO Providers",
      "type": "API",
      "direction": "Inbound",
      "protocol": "SAML 2.0 / OIDC",
      "authMethod": "SAML/OIDC",
      "dataFormat": "XML/JSON",
      "frequency": "On-demand",
      "description": "Enterprise SSO for portal authentication (Okta, Azure AD, etc.)"
    }
  ],
  "development": {
    "codingStandards": "Go: gofmt, golangci-lint. TypeScript: ESLint + Prettier. All code reviewed.",
    "branchStrategy": "Trunk-based development with short-lived feature branches. Main always deployable.",
    "codeReview": "All changes require 1 approval. Security-sensitive changes require security team review.",
    "documentation": "API docs auto-generated from OpenAPI/protobuf. Architecture decisions documented as ADRs.",
    "tools": [
      "VS Code",
      "GoLand",
      "GitHub Copilot",
      "Postman",
      "k9s"
    ]
  },
  "testing": {
    "strategy": "Comprehensive testing pyramid: unit tests for logic, integration tests for APIs, E2E tests for critical flows.",
    "unitTests": "80% code coverage minimum. Table-driven tests in Go. Jest for TypeScript.",
    "integrationTests": "API contract testing with Pact. Database integration tests with testcontainers.",
    "e2eTests": "Critical user flows tested with Playwright. Run in staging before production deploy.",
    "performanceTests": "Load testing with k6. Soak tests for memory leaks. Chaos engineering with Litmus.",
    "securityTests": "SAST (Semgrep), DAST (OWASP ZAP), dependency scanning (Snyk). Penetration testing quarterly.",
    "coverageRequirements": "80% line coverage, 90% for security-critical code",
    "testEnvironments": [
      "Local (Docker Compose)",
      "CI (GitHub Actions)",
      "Staging"
    ]
  },
  "risks": [
    {
      "id": "risk-spire-complexity",
      "description": "SPIRE operational complexity leads to reliability issues",
      "probability": "Medium",
      "impact": "High",
      "mitigation": "Invest in SPIRE expertise, implement comprehensive monitoring, document runbooks",
      "owner": "Platform Team",
      "status": "Open"
    },
    {
      "id": "risk-proxy-spof",
      "description": "Governance Proxy becomes single point of failure",
      "probability": "Low",
      "impact": "Critical",
      "mitigation": "Multi-AZ deployment, circuit breakers, graceful degradation",
      "owner": "Platform Team",
      "status": "Mitigated"
    },
    {
      "id": "risk-hsm-latency",
      "description": "HSM operations add unacceptable latency",
      "probability": "Medium",
      "impact": "Medium",
      "mitigation": "Credential caching, async encryption where possible, benchmark early",
      "owner": "Security Team",
      "status": "Open"
    }
  ],
  "constraints": [
    {
      "id": "con-1",
      "type": "Technical",
      "description": "Must use SPIFFE/SPIRE for identity (architectural decision)",
      "impact": "Tied to SPIFFE ecosystem",
      "rationale": "Foundation of security model"
    },
    {
      "id": "con-2",
      "type": "Compliance",
      "description": "Must achieve SOC 2 Type II within 18 months",
      "impact": "Affects development priorities and operational processes",
      "rationale": "Required for enterprise sales"
    },
    {
      "id": "con-3",
      "type": "Resource",
      "description": "Initial team of 8 engineers",
      "impact": "Limits parallel workstreams",
      "rationale": "Current headcount"
    }
  ],
  "assumptions": [
    {
      "id": "asm-1",
      "description": "Kubernetes will remain the deployment target",
      "rationale": "Industry standard for cloud-native",
      "validated": true,
      "risk": "Serverless alternatives gain traction"
    },
    {
      "id": "asm-2",
      "description": "LLM provider APIs remain stable",
      "rationale": "Major providers have stable production APIs",
      "validated": true,
      "risk": "Breaking changes require proxy updates"
    },
    {
      "id": "asm-3",
      "description": "PostgreSQL RLS provides sufficient isolation",
      "rationale": "Used successfully by large multi-tenant SaaS",
      "validated": false,
      "risk": "May need to move to database-per-tenant for large customers"
    }
  ],
  "glossary": [
    {
      "term": "SVID",
      "definition": "SPIFFE Verifiable Identity Document - an X.509 certificate encoding a SPIFFE ID",
      "acronym": "SVID"
    },
    {
      "term": "mTLS",
      "definition": "Mutual TLS - both client and server present certificates for authentication",
      "acronym": "mTLS"
    },
    {
      "term": "RLS",
      "definition": "Row-Level Security - PostgreSQL feature for tenant isolation at database level",
      "acronym": "RLS"
    },
    {
      "term": "HSM",
      "definition": "Hardware Security Module - dedicated hardware for cryptographic operations",
      "acronym": "HSM"
    },
    {
      "term": "OPA",
      "definition": "Open Policy Agent - CNCF policy engine using Rego language",
      "acronym": "OPA"
    },
    {
      "term": "HPA",
      "definition": "Horizontal Pod Autoscaler - Kubernetes feature for automatic scaling",
      "acronym": "HPA"
    }
  ]
}
